{% extends "SesileMainBundle:Default:index.html.twig" %}

{% block content %}
    <div class="bloc_page">
        <div class="titre_page">
            <span class="glyphicon glyphicon-floppy-saved"></span>
            &nbsp;&nbsp;&nbsp;Editer un service organisationnel
        </div>

        <form action="" class="form-horizontal" method="post" id="form">

            <div class="row">
                <label for="nom" class="col-lg-1 control-label">Nom</label>
                <div class="col-lg-6 ">
                    <input type="text" name="nom" class="form-control" id="nom" value="{{ service.nom }}">
                </div>
            </div>
            <br>
            <div class="row ">
                <label for="nom" class="col-lg-2 control-label">Types de classeur</label>
                <div class="col-lg-6">
                    {% for type in types %}
                        <input type="checkbox" name="types[]" {% if type in service.types %}checked{% endif %} value="{{ type.id }}"/>&nbsp;&nbsp;{{ type.nom }}<br>
                    {% endfor %}
                </div>
            </div>
            <br>
            <div class="row">
                <div class=" col-lg-12" style="height: 300px">
                    <div id="contetapes">
                        {% for etape in service.etapeGroupes %}

                        <div class="col-lg-2 well" >
                            <div>Etape de validation</div>
                            <select class="selusers " multiple="multiple" style="width: 100%">
                                <optgroup label="Groupes d'utilisateurs">
                                    {% for userPack in userPacks %}
                                        <option  value="userpack-{{ userPack.id }}" {% if userPack in etape.userPacks %} selected{% endif %} data-type="groupe">{{ userPack.nom }}</option>
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="utilisateurs">
                                    {% for user in users %}
                                        <option  value="user-{{ user.id }}" data-type="user" {% if user in etape.users %} selected{% endif %}>{{ user.prenom }} {{ user.nom }}</option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="col-lg-6">
                    <button type="button" class="btn btn-info" id="addetape"><span class="glyphicon glyphicon-plus-sign"></span>&nbsp;&nbsp;Ajouter une etape de validation</button>
                </div>
            </div>
            <br><br>
            <div class="form-group">
                <div class="col-lg-6">
                    <input type="submit" class="btn btn-success" value="Enregistrer le service organisationnel">
                </div>
                <input type="hidden" name="valeurs" id="valeurs">
            </div>

        </form>
        <br>

    </div>
    <script type="application/javascript" src="{{ asset("/js/select2.min.js") }}"></script>
    <link type="text/css" href="{{ asset("/css/select2.css") }}" rel="stylesheet"/>
    <script>
        $(document).ready(function() {

            $(".selusers").select2();
            $(document).on('click','#addetape',function(){
                /*
                 A chaque fois qu'on clicque sur le bouton bleu une nouvelle etape de validation se crée
                 */
                $('#contetapes').append('' +
                '<div class="col-lg-2 well" ><div>Etape de validation</div><select class="selusers " multiple="multiple" style="width: 100%"><optgroup label="Groupes d\'utilisateurs">{% for userPack in userPacks %}<option  value="userpack-{{ userPack.id }}" data-type="groupe">{{ userPack.nom }}</option>{% endfor %}</optgroup><optgroup label="utilisateurs">{% for user in users %}<option  value="user-{{ user.id }}" data-type="user">{{ user.prenom }} {{ user.nom }}</option>{% endfor %}</optgroup></select></div>');
                $("select.selusers").select2();

            });
            var tabGeneral = [];
            var tabEtape = [];
            var ItemSelected = {};
            $('#form').submit(function(){
                /*
                 * Pour chaque etape de validation créé on récupère les options sélectionnées
                 *
                 * */
                $('select.selusers').each(function(){
                    var tabEtape = [];
                    if($(this).val())
                    {
                        $(this).find(':selected').each(function(){
                            /*
                             * Pour chaque option selectionnée, on récupère son data-type(groupe ou user) et sa value (id du user ou du userPack)
                             * */
                            var ItemSelected = {};
                            ItemSelected.entite = $(this).data('type');
                            ItemSelected.id = $(this).val();
                            tabEtape.push(ItemSelected);
                        });
                        tabGeneral.push(tabEtape);
                    }
                });
                /*
                 * on met tout ça dans un tableau que l'on stringifie et qu'on met dans le hidden
                 * */
                $('#valeurs').val(JSON.stringify(tabGeneral));
                tabGeneral = [];
            });





        });
    </script>
{% endblock %}