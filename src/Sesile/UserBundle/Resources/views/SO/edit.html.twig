{% extends "SesileMainBundle:Default:index.html.twig" %}

{% block content %}
    <div class="bloc_page">
        <div class="titre_page">
            <span class="glyphicon glyphicon-floppy-saved"></span>
            &nbsp;&nbsp;&nbsp;Editer un service organisationnel
        </div>

        <form action="{{ path('modify_serviceorg', {id:service.id}) }}" class="form-horizontal" method="post" id="form">

            <div class="row">
                <label for="nom" class="col-lg-1 control-label">Nom</label>
                <div class="col-lg-6 ">
                    <input type="text" name="nom" class="form-control" id="nom" value="{{ service.nom }}">
                </div>
            </div>
            <br>
            <div class="row ">
                <label for="nom" class="col-lg-2 control-label">Types de classeur</label>
                <div class="col-lg-8">
                    <div class="row">
                    {% for type in types %}

                        <div class="col-lg-1 text-right">
                            <input type="checkbox" name="types[]" {% if type in service.types %}checked{% endif %} value="{{ type.id }}" id="types_classeur_{{ type.id }}"/>
                        </div>
                        <div class="col-lg-2 text-left">
                            <label for="types_classeur_{{ type.id }}">{{ type.nom }}</label>
                        </div>

                    {% endfor %}
                    </div>
                </div>
            </div>
            <br>
            <div class="row">
                <div class=" col-lg-12" style="height: 300px">
                    <div id="contetapes" class="ui-sortable">
                        {% for etape in service.etapeGroupes %}

                        <div class="col-lg-2 well etapes-circuit">
                            <div class="text-center"><h4>Etape de validation {{ etape.id }}</h4></div>
                            {#<input type="hidden" name="etape_id" value="{{ etape.id }}">#}
                            <select class="selusers" multiple="multiple" style="width: 100%" data-etape="{{ etape.id }}">
                                <optgroup label="Groupes d'utilisateurs">
                                    {% for userPack in userPacks %}
                                        <option value="userpack-{{ userPack.id }}" {% if userPack in etape.userPacks %} selected{% endif %} data-type="groupe">{{ userPack.nom }}</option>
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="utilisateurs">
                                    {% for user in users %}
                                        <option value="user-{{ user.id }}" data-etape="{{ etape.id }}" data-type="user" {% if user in etape.users %} selected{% endif %}>{{ user.prenom }} {{ user.nom }}</option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                            <button type="button" class="btn btn-danger btn-suppetape" id="suppetape"><span class="glyphicon glyphicon-minus-sign"></span> Supprimer cette étape</button>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="col-lg-2 text-center">
                        <button type="button" class="btn btn-info btn-ajout-etape" id="addetape"><span class="glyphicon glyphicon-plus-sign"></span><br>Ajouter une étape</button>
                    </div>
                </div>
            </div>
            <br><br>
            <div class="form-group">
                <div class="col-lg-6">
                    <input type="submit" class="btn btn-success" value="Enregistrer le service organisationnel">
                </div>
                <div class="col-lg-2">
                    <a class="btn btn-primary pull-right" href="{{ path('servicesorg') }}">
                        <span class="glyphicon glyphicon-share-alt"></span>&nbsp;&nbsp;Retour aux S.O.
                    </a>
                </div>
                <input type="hidden" name="valeurs" id="valeurs">
            </div>

        </form>
        <br>

    </div>
    <script type="application/javascript" src="{{ asset("/js/select2.min.js") }}"></script>
    <link type="text/css" href="{{ asset("/css/select2.css") }}" rel="stylesheet"/>

    <script type="text/javascript" src="{{ asset('/js/jquery-ui.min.js') }}"></script>
    {#<script type="text/javascript" src="{{ asset('/js/circuit_etape.js') }}"></script>#}

    <script>
        $(document).ready(function() {

            $(".selusers").select2();

            // Pour le bouton de suppression de l etape
            $(document).on('click','#suppetape',function() {
                $(this).parent().remove();
            });


            $(document).on('click','#addetape',function(){
                /*
                 A chaque fois qu'on clicque sur le bouton bleu une nouvelle etape de validation se crée
                 */
                $('#contetapes').append('' +
                '<div class="col-lg-2 well etapes-circuit"><div class="text-center"><h4>Etape de validation</h4></div><select class="selusers" multiple="multiple" style="width: 100%" data-etape="0"><optgroup label="Groupes d\'utilisateurs">{% for userPack in userPacks %}<option value="userpack-{{ userPack.id }}" data-type="groupe">{{ userPack.nom }}</option>{% endfor %}</optgroup><optgroup label="utilisateurs">{% for user in users %}<option value="user-{{ user.id }}" data-type="user">{{ user.prenom }} {{ user.nom }}</option>{% endfor %}</optgroup></select><button type="button" class="btn btn-danger btn-suppetape" id="suppetape"><span class="glyphicon glyphicon-minus-sign"></span> Supprimer cette étape</button></div>');
                $("select.selusers").select2();

            });
            var tabGeneral = [];
            $('#form').submit(function(){
                /*
                 * Pour chaque etape de validation créé on récupère les options sélectionnées
                 *
                 * */
                $('select.selusers').each(function(){

                    var Etapes = {};
                    Etapes.etape_id = $(this).data('etape');
                    Etapes.etapes = [];

                    if($(this).val())
                    {
                        $(this).find(':selected').each(function(){
                            /*
                             * Pour chaque option selectionnée, on récupère son data-type(groupe ou user) et sa value (id du user ou du userPack)
                             * */
                            Etapes.etapes.push({
                                entite: $(this).data('type'),
                                id: $(this).val()
                            });
                        });
                    } else {
                        e.preventDefault();
                    }
                    tabGeneral.push(Etapes);
                });

                /*
                 * on met tout ça dans un tableau que l'on stringifie et qu'on met dans le hidden
                 * */
                $('#valeurs').val(JSON.stringify(tabGeneral));
//                tabGeneral = [];
            });

            $(function() {
                $( "#contetapes" ).sortable({
                    tolerance: "pointer"
                }).disableSelection();
            });



        });
    </script>
{% endblock %}